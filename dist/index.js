import{defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as n,ref as t,watchEffect as o,onMounted as r,resolveComponent as l,openBlock as a,createElementBlock as i,createElementVNode as u,createCommentVNode as s,createVNode as c,createTextVNode as d,Fragment as p,renderList as f,toDisplayString as m}from"vue";const y={id:"bunny-upload-directus"},g={key:0,class:"loader"},v={class:"upload-container"},h=["for"],b=["id"],x={key:0,class:"file-info"};var w=n({__name:"interface",props:{folder:{type:String,default:""},collection_as_subfolder:{type:Boolean,default:!0},value:{type:String,default:null},collection:{type:String,default:null},primaryKey:{type:[String,Number],default:null}},emits:["input"],setup(e,{emit:n}){const w=e,k=n,$=t("https://la.storage.bunnycdn.com/mckp-live-storage"),S=t("840f968d-7235-4c28-8da439cda2f5-1a6f-4d68"),_=t("https://mockup-live-cdn.b-cdn.net"),C=t([]),N=t(!1),D=t(""),U=(()=>{if(w.primaryKey&&"+"!==w.primaryKey)return console.log("Using primaryKey from props:",w.primaryKey),w.primaryKey;try{const e=window.location.pathname.split("/"),n=e[e.length-1];if(n&&!isNaN(Number(n)))return console.log("Extracted ID from URL:",n),n}catch(e){console.error("Error extracting ID from URL:",e)}return null})();let A="";w.collection&&(A=w.collection,U?A=`${A}/${U}`:console.warn("Не удалось получить ID документа")),w.folder&&(A=w.folder+(A?`/${A}`:"")),console.log("Folder path:",A),console.log("Collection:",w.collection),console.log("Item ID:",U);const j=()=>N.value=!N.value,T=e=>{if(e)try{const n=JSON.parse(e);if(Array.isArray(n))C.value=n.map((e=>{const n=e.split("/");return n[n.length-1]}));else{const n=e.split("/");C.value=[n[n.length-1]]}}catch(n){try{const n=e.split("/");C.value=[n[n.length-1]]}catch(e){console.error("Ошибка при извлечении имени файла:",e),C.value=[]}}else C.value=[]};async function B(e,n){j();const t=A?`${$.value}/${A}/${e}`:`${$.value}/${e}`,o=S.value;try{const r=await fetch(t,{method:"PUT",body:n,headers:{"content-type":"application/octet-stream",AccessKey:o}});if(!r.ok)throw new Error(`HTTP error! Status: ${r.status}`);return j(),A?`${_.value}/${A}/${e}`:`${_.value}/${e}`}catch(e){throw j(),console.error("Error uploading to Bunny CDN:",e),e}}return o((()=>{w.value&&T(w.value)})),r((()=>{D.value=`file-upload-${((e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,n)=>e+((n&=63)<36?n.toString(36):n<62?(n-26).toString(36).toUpperCase():n>62?"-":"_")),""))(5)}`,w.value&&T(w.value)})),(e,n)=>{const t=l("v-icon");return a(),i("div",y,[N.value?(a(),i("div",g,n[1]||(n[1]=[u("div",null,"Uploading file to Bunny CDN please wait...",-1)]))):s("v-if",!0),u("div",v,[u("label",{for:D.value,class:"custom-file-upload"},[c(t,{name:"upload",left:""}),n[2]||(n[2]=d(" Upload file to Bunny CDN "))],8,h),u("input",{id:D.value,type:"file",multiple:"",style:{display:"none"},onChange:n[0]||(n[0]=e=>async function(e){if(e&&e.length>0){const n=[];C.value=[];for(const t of Array.from(e))try{const e=t.name.split("."),o=e.pop()||"",r=e.join("."),l=(e=>{const n="abvgdeejzijklmnoprstufhzcssyye";return e.split("").map((e=>{const t=e.toLowerCase(),o="абвгдеёжзийклмнопрстуфхцчшщъыьэюя".indexOf(t);return o>=0?e===t?n[o]:n[o].toUpperCase():e})).join("")})(String(r)).toLowerCase().replace(/[^\w\-]/g,"_").replace(/_{2,}/g,"_"),a=((new Date).getTime().toString(),`${l}-${Math.random().toString(36).substring(2,6)+Date.now().toString(36).substring(0,4)}.${o}`);C.value.push(a);const i=await B(a,t);n.push(i)}catch(e){console.error("Ошибка при обработке файла:",e);const n=C.value.pop();console.warn(`Файл ${n} не был загружен.`)}n.length>0&&k("input",JSON.stringify(n))}}(e.target.files))},null,40,b),C.value.length>0?(a(),i("div",x,[c(t,{name:"description"}),u("ul",null,[(a(!0),i(p,null,f(C.value,(e=>(a(),i("li",{key:e,class:"file-name"},m(e),1)))),128))])])):s("v-if",!0)])])}}}),k=[],$=[];!function(e,n){if(e&&"undefined"!=typeof document){var t,o=!0===n.prepend?"prepend":"append",r=!0===n.singleTag,l="string"==typeof n.container?document.querySelector(n.container):document.getElementsByTagName("head")[0];if(r){var a=k.indexOf(l);-1===a&&(a=k.push(l)-1,$[a]={}),t=$[a]&&$[a][o]?$[a][o]:$[a][o]=i()}else t=i();65279===e.charCodeAt(0)&&(e=e.substring(1)),t.styleSheet?t.styleSheet.cssText+=e:t.appendChild(document.createTextNode(e))}function i(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),n.attributes)for(var t=Object.keys(n.attributes),r=0;r<t.length;r++)e.setAttribute(t[r],n.attributes[t[r]]);var a="prepend"===o?"afterbegin":"beforeend";return l.insertAdjacentElement(a,e),e}}("\n#bunny-upload-directus {\n  width: 100%;\n  padding: 20px;\n  border: 1px solid var(--v-input-border-color-hover, var(--theme--form--field--input--border-color-hover));\n  border-radius: 10px;\n  position: relative;\n}\n#bunny-upload-directus .upload-container {\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n}\n\n/* Стилизация кнопки загрузки */\n#bunny-upload-directus .custom-file-upload {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8px;\n  padding: 8px 12px;\n  background-color: var(--theme--primary);\n  color: var(--theme--primary-background);\n  border-radius: 4px;\n  cursor: pointer;\n  font-weight: 500;\n  transition: background-color 0.2s ease;\n  width: fit-content;\n}\n#bunny-upload-directus .custom-file-upload:hover {\n  background-color: var(--theme--primary-accent);\n}\n#bunny-upload-directus .file-info {\n  margin-top: 10px;\n  padding: 10px;\n  background: var(--theme--form--field--input--background);\n  border-radius: 5px;\n  border: 1px solid var(--v-input-border-color-hover, var(--theme--form--field--input--border-color-hover));\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n#bunny-upload-directus .file-info ul {\n  list-style: none;\n  padding: 0;\n  margin: 0;\n}\n#bunny-upload-directus .file-info li {\n  margin-bottom: 5px;\n}\n#bunny-upload-directus .file-name {\n  font-weight: 500;\n  word-break: break-all;\n}\n#bunny-upload-directus .loader {\n  background: var(--theme--form--field--input--background);\n  text-align: center;\n  position: absolute;\n  border-radius: 10px;\n  width: 100%;\n  height: 100%;\n  top: 0;\n  left: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: var(--v-input-color);\n}\n",{}),w.__file="src/interface.vue";var S=e({id:"bunny-upload-files",name:"Bunny CDN Upload Files",icon:"file_present",description:"Interface to receive files and send to Bunny!",group:"relational",component:w,relational:!0,options:[{field:"folder",name:"Folder",meta:{width:"full",interface:"input",options:{placeholder:"folder (without start/end slash)"}}},{field:"collection_as_subfolder",name:"Include collection name as subfolder",type:"boolean",meta:{width:"half",interface:"boolean"},schema:{default_value:!0}}],types:["string"]});export{S as default};
